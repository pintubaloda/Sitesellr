Sitesellr Cumulative Requirement Status
Updated: 2026-02-18

Requested Scope	Status	Developed Now	Remaining
Server-side validation + DTO tightening	Developed (this pass)	Tightened DTO validation with DataAnnotations and server checks for Merchant Ops, Team, Invites, and Role Templates APIs (invalid action/role/scope/department/status blocked, duplicate assignment checks, normalized permission CSV).	Apply same strict DTO validation pattern across older legacy endpoints not yet covered.
Migration files for governance tables	Developed (this pass)	Added idempotent EF migration `20260218142000_GovernanceTables` for merchant onboarding, role templates, sensitive approvals, franchise units/stores, and backoffice assignments.	Generate designer/snapshot via `dotnet ef` once .NET SDK is available in CI/dev environment.
Smoke-test checklist for new admin pages/APIs	Developed (this pass)	Added `SMOKE_TEST_CHECKLIST_ADMIN.md` covering Platform RBAC, Merchants, Merchant Ops, Team, Invite Acceptance, Role Templates, Audit Logs, and API negative validation checks.	Automate this checklist in integration/e2e pipeline.

Previous in-progress governance modules	Developed (core)	Lifecycle ops, onboarding profile, team invite/accept, role templates, approvals queue, franchise/backoffice workflows, and audit logging remain implemented and wired.	Production hardening: SMTP reliability, approval chains, immutable audit retention, enterprise permission builder UX.

Git state
- Last pushed commit: 0f4b927
- Current validation + migration + smoke-checklist changes are local and pending commit/push.

---
Cumulative Main Requirement Status Matrix (Do Not Remove Previous Entries)
Updated: 2026-02-18

Module Name	Developed	Partial Developed	Need To Develop
User / Merchant Management	Merchant onboarding flow (register->OTP placeholder->plan->store setup), tenant resolver middleware, core RBAC scaffold, team invite/accept, lifecycle APIs/UI, franchise/backoffice base models	Platform owner seed/delegation flows, custom role builder UX, lifecycle bulk ops and approval chains	Business onboarding automation, full franchise hierarchy workflows, enterprise role governance
Storefront System (Retail + Wholesale)	Landing + auth/onboarding screens, responsive frontend base	Theme/layout pages exist but not full storefront CMS, B2B visibility toggles not complete	Theme marketplace, drag-drop homepage builder, navigation builder, static page CMS, hybrid retail/wholesale runtime controls
Product Management	Products/categories/variants/media core entities + CRUD APIs wired	Bulk upload, advanced inventory rules, wholesale MOQ/tier pricing partial placeholders	Complete wholesale rule engine (MOQ/pack/case/tier), Excel import/export, richer media/video pipeline
Order Management	Orders/order-items core entities + CRUD APIs, lifecycle status fields, notes basics	Invoice/GST flow partial, refund/cancel flow partial, shipment integrations partial	Complete unified order engine (retail/wholesale/social/manual), GST invoice generation, refunds + courier integrations + audit-grade transitions
Customer Management	Customers + addresses + CRUD APIs wired	Customer groups/segmentation and B2B credit ledger partial	Guest checkout model, GSTIN enforcement rules, customer-specific pricing matrix, full segmentation workflows
Payments & Financial Features	Payment plugin interface scaffold, billing plan/subscription models scaffold	Real gateways, tokenized card/wallet storage, UPI/COD flows incomplete	Production gateway plugins, partial payment/refund settlement flows, reconciliation, payouts, GST finance reporting
Store Builder & Customization	Branding/auth UI customization done for onboarding/auth pages	Theme controls minimal and not merchant self-serve	Live preview editor, section builder, custom CSS/JS sandbox, banner/slider/store identity management
Plugin / App Ecosystem	Plugin architecture direction started (payment plugin registry)	No install/uninstall marketplace flow yet	Full app marketplace, permission scopes, plugin billing, developer portal, integration categories
Logistics & Fulfillment	Data model hooks available via existing order domain	No full logistics module yet	Shipping rule engine, courier APIs, pincode serviceability, labels, returns, wholesale freight workflows
Marketing & Growth	Basic platform shell only	Discount/coupon foundations not fully implemented	Discount engine, flash sales, combo offers, abandoned cart recovery, email/SMS/WhatsApp automation, SEO/social tools
Reporting & Analytics	Audit logs viewer + key admin logs	Sales/traffic/product analytics dashboards partial	Full BI dashboards, GST/tax reports, conversion funnels, exportable analytics
Security & Compliance	Opaque tokens, Turnstile verify wiring, rate-limit hooks, tenancy isolation, policy-based auth, audit logs	MFA/WebAuthn partial config only, CSRF hardening partial, DataProtection key persistence pending	Production-grade MFA/WebAuthn rollout, KMS encryption for secrets, backup/recovery controls, fraud scoring + incident workflows
Advanced / Competitive Features	Architecture allows future extensibility	No AI/multi-channel modules yet	AI assistants, smart pricing/fraud/catalog, WhatsApp/POS/marketplace channel connectors
SaaS Business Engine	Billing plan/subscription base models + some admin endpoints	Usage metering and feature gating partial	Trial automation, usage limits, upgrade/downgrade, add-on monetization, subscription ops dashboard
Technical Architecture	Backend .NET + PostgreSQL + React frontend wired; Docker/Render deployment files present	Read/write split, replication strategy, infra automation partial	Production cloud architecture (AWS/Azure), HA, observability, backups, scaling playbooks

---
Storefront CMS & Theme Engine Update
Updated: 2026-02-18

Module Name	Developed	Partial Developed	Need To Develop
Storefront System (Retail + Wholesale)	Theme catalog API + store theme apply with plan eligibility checks; store design settings API (logo, favicon, header/footer/banner/design tokens); homepage layout API (sections JSON); navigation menu API; static pages CRUD API; Store Builder UI fully wired to real backend endpoints	Drag-and-drop behavior is section-list based (not full visual DnD canvas), media upload is URL-based for now, no public storefront renderer yet	Public storefront rendering engine, visual DnD editor, menu nesting UI, file asset upload pipeline/CDN, B2B mode controls (hide price/login-to-view/customer-specific catalog)
Store Builder & Customization	Admin `/admin/store-builder` now works with real APIs for themes, customization, homepage sections, navigation, and static pages	Advanced theme live preview and granular widget setting forms are partial	Theme marketplace billing automation, advanced section widgets, reusable layout templates, localization controls
Plugin / App Ecosystem	Theme catalog supports free/paid + allowed plan code gates at platform level	No platform owner UI for theme CRUD yet (API available)	Full app marketplace UX, install/uninstall lifecycle, plugin billing and review workflow

---
Store Builder & Customization Expansion
Updated: 2026-02-18

Module Name	Developed	Partial Developed	Need To Develop
Theme / Design Engine	Theme marketplace API + platform owner theme create/list UI + store theme apply with plan gating; live preview runtime route `/s/:subdomain/*`; section-based homepage layout persistence + editor; custom JSON token controls (header/footer/banner/design)	Visual drag-drop is reorder-based (up/down + section editor), advanced WYSIWYG widget tooling is partial	Full visual drag canvas with nested sections, versioned theme publishing workflow, safe sandbox for merchant custom JS
Branding Controls	Logo/favicon upload API (`/storefront/media/upload`) + media asset registry, colors/typography via design tokens JSON, banners/sliders via JSON blocks, storefront runtime uses active branding	Media pipeline currently local static storage (or ASSET_BASE_URL mapping) and not fully external CDN-managed	Managed CDN integration, asset optimization/transform pipeline, advanced typography presets/UI controls
Storefront Runtime + B2B Visibility	Public storefront APIs + frontend renderer consume theme/layout/navigation/pages/products; pricing visibility flags wired (`showPricing`, `loginToViewPrice`, `catalogMode`, `catalogVisibilityJson`)	Customer-specific catalog visibility still JSON-driven (no business-rule UI), login-gated pricing policy needs end-user auth enforcement on public storefront	Complete B2B rule engine + customer-group catalog filters + enforced authenticated B2B storefront sessions

---
Custom Domain + Free SSL Utility Update
Updated: 2026-02-18

Module Name	Developed	Partial Developed	Need To Develop
Custom Domain + SSL	Store domain management API + UI (add/list/verify/issue SSL), free SSL provider abstraction added (`ISslProvider`), Let's Encrypt shell provider integrated via `SSL_ISSUER_COMMAND`, domain SSL status tracking (pending/issuing/active/failed), expiry/error persisted	DNS verification currently manual confirm endpoint (designed for Cloudflare DNS workflows), certificate provisioning depends on system-level ACME command configuration	Automated Cloudflare DNS-01 verification API integration, auto-renew scheduler/worker, paid SSL marketplace providers, cert deployment automation to edge/proxy infrastructure
Store Builder / Storefront Security	Public storefront runtime + B2B visibility flags retained and integrated with current settings	Strict custom JS sandbox not implemented yet	Isolated custom JS runtime with allowlist, CSP nonce enforcement, permission-scoped app scripts

---
Build Fix Update
Updated: 2026-02-18

Module Name	Developed	Partial Developed	Need To Develop
Migration Build Stability	Fixed storefront CMS migration compile syntax for CI	-	-

---
Build Fix Update
Updated: 2026-02-18

Module Name	Developed	Partial Developed	Need To Develop
Migration Build Stability	Fixed storefront public/B2B/media migration compile syntax for CI	-	-

---
Build Fix Update
Updated: 2026-02-18

Module Name	Developed	Partial Developed	Need To Develop
Migration Build Stability	Fixed store domain/free-SSL migration compile syntax for CI	-	-

---
Cloudflare Tenant Subdomain + Auto SSL Flow Update
Updated: 2026-02-18

Module Name	Developed	Partial Developed	Need To Develop
Tenant Subdomain (store.sitesellr.com)	Cloudflare DNS integration service added; on store create/update system auto-ensures tenant CNAME via Cloudflare API using configured zone/token/base domain/ingress host	No bulk reconciliation job yet for existing stores	Backfill worker for all existing stores and drift detection dashboard
Custom Domain + Free SSL	On custom domain add, system now auto-attempts DNS resolve verification and SSL issuance; if auto fails, UI fallback button `Verify Now` + `Issue SSL` is available	Auto verify currently checks DNS resolvability (not full delegated DNS TXT validation automation)	Full Cloudflare DNS-01 TXT automation per custom domain provider integration, scheduled auto-renew queue and retry backoff

---
Visual Drag-Drop Canvas Foundation Update
Updated: 2026-02-18

Module Name	Developed	Partial Developed	Need To Develop
Visual Drag-Drop Canvas	Added layout schema validation API, version history table/API, publish + rollback APIs, Store Builder undo/redo timeline, nested block (children) editing in section tree, responsive preview now renders nested blocks	WYSIWYG freeform drag surface is still simplified (list/tree interactions), nesting depth tooling basic, no collaborative editing	Full canvas interaction engine with true drag-n-drop between containers, deep nesting UX, advanced inspector panels, multi-user editing controls
Versioning & Governance	Draft versions auto-created on save, publish/rollback wired to version IDs, version list shown in UI	No release notes per version, no lock/freeze workflow, no scheduled publish	Full version governance (approval gates, scheduled publish, diff viewer, immutable release snapshots)

---
WYSIWYG Canvas Deep-Nesting Update
Updated: 2026-02-18

Module Name	Developed	Partial Developed	Need To Develop
Visual Drag-Drop Canvas	Added freeform nested canvas rendering with recursive drop targets, node-level drag/reparent as child, advanced inspector fields (type/title/style settings), and JSON-backed node identity model	Reparent currently supports drop-as-child (no before/after drop zones yet), no multi-select/group operations	Pixel-perfect freeform absolute positioning mode, container grid snapping, full drag handles by breakpoint
Editor UX	Undo/redo timeline maintained with deep snapshots; selected-node inspector edits settings JSON + style fields in real time	No timeline scrubber UI and no collaborative conflict resolution	Operational transform/CRDT collaboration, timeline diff viewer, visual history playback

---
Canvas Advanced UX Update (Before/After + Grid + Timeline)
Updated: 2026-02-18

Module Name	Developed	Partial Developed	Need To Develop
Visual Drag-Drop Canvas	Added before/after drop zones, deep nested drag-as-child and sibling positioning, absolute/freeform mode toggle, grid snapping controls, inspector position sizing (x/y/w), timeline playback panel with step jump and node diff counters	Absolute mode currently manual-position via inspector values (not direct pointer drag), playback is local editor history (single-user)	Direct pointer-based absolute drag handles, multi-user collaborative timeline, semantic diff merge workflow

---
Collaboration Timeline & Diff Foundation Update
Updated: 2026-02-18

Module Name	Developed	Partial Developed	Need To Develop
Collaboration Timeline / Diff Playback	Added backend version-diff API (added/removed/renamed node deltas), editor collaboration session APIs (heartbeat/list/end), and frontend collaboration panel with active editors + diff summary viewer	Single-store polling model only; no real-time websocket sync or conflict merge	CRDT/OT real-time merge, live cursor presence, conflict resolution UI and permissions workflow

---
Realtime Sync / OT-like Merge / Live Cursor Update
Updated: 2026-02-18

Module Name	Developed	Partial Developed	Need To Develop
Realtime Sync (WebSocket)	Added websocket collaboration endpoint `/ws/storefront/{storeId}` with snapshot/presence/op messaging and client heartbeat integration in Store Builder	In-memory room state only; no distributed backplane yet	Redis/backplane fanout for multi-instance horizontal scale
OT/CRDT Conflict Handling	Implemented revision-based operation acceptance + conflict response (`conflict` returns server snapshot) for safe convergence	This is OT-like revision gating, not full CRDT/OT transform algorithm	True CRDT/OT transform engine with operation-level semantic merge
Live Cursor Co-editing	Added live cursor broadcasts (`cursor` events) and remote cursor presence indicators in builder UI	Cursor coordinates currently minimal (node-focused, not pixel cursor map)	Full live cursor coordinates, colored user avatars, viewport-aware cursor rendering

---
Build Fix Update
Updated: 2026-02-18

Module Name	Developed	Partial Developed	Need To Develop
Realtime Collaboration Build Stability	Fixed compile/runtime compatibility for websocket send calls and tenancy warning cleanup	-	-

---
B2B Customer-Group Visibility Engine Update
Updated: 2026-02-18

Module Name	Developed	Partial Developed	Need To Develop
B2B Customer-Group Visibility Engine	Added DB models/tables for customer groups, group members, and visibility rules; added admin APIs for group/rule management; public storefront enforcement now filters products/pages/theme blocks by allow/deny rules and preview group id	Category-level enforcement model exists but not yet applied in product query path; preview-as-group UI is basic (ID-driven), rule builder is form-based (not visual)	Rich rule-builder UX with entity pickers, customer-group assignment UI at scale, full category cascade enforcement, policy simulation/audit and conflict resolution workflow

---
Registration CORS + Test Role Credentials Seed Update
Updated: 2026-02-18

Module Name	Developed	Partial Developed	Need To Develop
Registration CORS	Adjusted CORS policy: explicit origins now enable credentials; wildcard stays non-credential mode for safety	If frontend uses `withCredentials=true`, wildcard CORS still fails by browser design	Set concrete `CORS_ORIGINS` in all deploy envs and keep front/back URL alignment
Test Role Login Setup	Added optional runtime dev seed (`SEED_TEST_USERS=true`) to generate platform/store role users with known password and assign roles/store demo data	Seeding is env-flagged and intended for non-production test only	Separate secure test-fixture bootstrap pipeline for CI/staging with rotated secrets

---
Seed Credential Reliability Fix
Updated: 2026-02-18

Module Name	Developed	Partial Developed	Need To Develop
Test Role Login Stability	Seed flow now enforces known password + unlocked state for all seeded test users on startup	-	-

---
Test Password Default Update
Updated: 2026-02-18

Module Name	Developed	Partial Developed	Need To Develop
Test Role Login Setup	Default seed password updated to `9414064554` when `TEST_USER_PASSWORD` is not provided	-	-

---
Auth CSRF Fix Update
Updated: 2026-02-18

Module Name	Developed	Partial Developed	Need To Develop
Authentication Flow Stability	CSRF middleware now exempts auth bootstrap endpoints (login/register/refresh/logout/onboarding/team invite accept) to prevent first-login `csrf_invalid` failures	-	-

---
Role-Based UI Visibility Update
Updated: 2026-02-18

Module Name	Developed	Partial Developed	Need To Develop
Platform vs Store Feature Visibility	Added backend access summary endpoint (`GET /api/auth/access`) and dynamic sidebar visibility by platform/store scope so platform owner/staff and store users no longer see identical menu options	Page-level button/action guards still partly API-enforced (403 fallback) and not fully hidden in all screens	Complete route/action-level guard matrix and per-component permission gating for every admin view

[2026-02-18 19:16 IST] Platform Owner Governance Hardening (In Progress)
- Developed:
  - Expanded platform permission catalog with explicit super-admin scopes (merchant governance, payments oversight, billing governance, platform settings, security, fraud/risk, plugin governance, API governance, API credentials, webhooks/integrations).
  - Added backend policy keys for high-risk capabilities (merchant suspend/delete, refund override, payout freeze/release, plans manage, security policies manage, plugin approve, API key revoke).
  - Added auth access payload enrichment: platform permissions + high-risk action map from `/api/auth/access`.
  - Added sensitive-action enforcement for platform RBAC writes: `reason` required and optional step-up guard via `REQUIRE_STEP_UP_FOR_SENSITIVE=true` with `X-Step-Up-Auth=true`.
  - Added sensitive action audit entries for RBAC updates and merchant approval flow actions.
  - Added platform owner permission catalog endpoint: `GET /api/platform/rbac/catalog/platform-owner`.
  - Updated admin sidebar scope behavior so platform owner no longer auto-sees store-only menus without store role context.
  - Updated Platform RBAC UI to send reason + optional step-up header for sensitive writes.
- Partial:
  - Step-up currently header-gated (`X-Step-Up-Auth`) and config-driven; not yet a full 2FA challenge handshake.
  - Platform owner permissions are role-derived in tenancy context (template) and not yet persisted as independent platform permission grants.
- Pending:
  - Dual approval workflow for high-risk actions.
  - Dedicated financial intervention endpoints with enforced policy-per-action + re-auth screens.
  - Immutable audit export/signing pipeline and approval reason taxonomy.

[2026-02-19 08:48 IST] Storefront Theme Marketplace Expansion + Category Selection
- Developed:
  - Seeded 10 category-oriented storefront themes (free + paid mix) for: General, Fashion/Apparel, Electronics, Grocery/FMCG, Pharmacy, B2B Wholesale, Restaurant/Food, Single Product, Minimal Catalog, Premium Luxury.
  - Theme seeding logic now upserts by slug (adds missing themes without duplicating existing catalog).
  - Store Builder UI now supports theme category filter + text search for easier merchant selection.
  - Theme marketplace now shows filtered count and empty-state messaging.
- Partial:
  - Public storefront rendering runtime remains template/section-json based (no full theme runtime packages yet).
  - Paid theme purchase flow still plan-eligibility gated (no separate one-click theme checkout yet).
- Pending:
  - Full visual theme preview sandbox with per-device live preview snapshots.
  - Theme plan assignment management UI for platform owner (bulk pricing/category management).

[2026-02-19 08:52 IST] Platform Owner Theme Lifecycle UI + APIs
- Developed:
  - Platform theme lifecycle APIs added: update theme, publish, unpublish, feature/rank.
  - Platform themes list ordering now prioritizes featured themes and featured rank.
  - Theme model extended with lifecycle metadata: `IsFeatured`, `FeaturedRank`, `UpdatedAt`.
  - Startup schema safety adds missing theme catalog columns for lifecycle/featured support.
  - Platform owner UI now supports: publish/unpublish, pricing update, plan mapping updates, featured toggle/rank save.
- Partial:
  - Bulk actions (multi-select publish/rank/plan mapping) not implemented.
  - No separate approval flow for theme unpublish/price changes.
- Pending:
  - Theme lifecycle audit timeline view (who changed price/rank/status).
  - Advanced sorting presets and scheduled publish/unpublish windows.

[2026-02-19 09:11 IST] Storefront Follow-up: Nested Menus + Premium Sections + Wholesale Messaging
- Developed:
  - Navigation module upgraded to nested menu editor in Store Builder (parent/child menu management in UI).
  - Public storefront header renderer now supports recursive nested menus.
  - Added Section Marketplace in homepage builder with free + premium section presets for faster merchant composition.
  - Public storefront now shows wholesale-mode messaging: MOQ hint + Request Quote CTA when catalog mode is wholesale/hybrid.
  - MOQ message reads `defaultMoq` from `catalogVisibilityJson` if configured (fallback 10).
- Partial:
  - Nested menu drag-reorder and visibility-by-customer/device controls are not yet implemented.
  - Premium section monetization is UI-level preset flow; no separate paid section checkout/gating yet.
  - Quote CTA is present but not connected to inquiry workflow/ticketing.
- Pending:
  - Full visual nested navigation tree with reorder handles and role/device conditions.
  - Premium section billing hooks (purchase/entitlement checks).
  - End-to-end quote/inquiry backend + admin pipeline.

[2026-02-19 09:19 IST] Requested Scope Completed: Nested Menu Rules + Premium Entitlements + Quote Workflow
- Developed:
  - Nested menu conditional visibility rules added (customer type / login state / device) in Store Builder menu editor and public storefront renderer.
  - Nested menu sibling reorder controls (up/down) added for parent and child nodes.
  - Premium section entitlement enforcement added end-to-end:
    - Backend entitlement API: `GET /api/stores/{storeId}/storefront/section-entitlements`
    - Backend save/validate guard blocks unauthorized premium sections in homepage layout.
    - Frontend section marketplace now disables locked premium sections by plan.
  - Quote inquiry backend workflow added:
    - Public submit endpoint: `POST /api/public/storefront/{subdomain}/quote-inquiries`
    - Admin list endpoint: `GET /api/stores/{storeId}/storefront/quote-inquiries`
    - Admin status update endpoint: `PUT /api/stores/{storeId}/storefront/quote-inquiries/{id}/status`
    - Store Builder UI panel added to process quote statuses.
  - Public storefront wholesale CTA now submits real quote request to backend.
- Partial:
  - Menu reorder is button-based (up/down), not drag-handle DnD yet.
  - Menu visibility currently supports single customerType/login/device rule per item (not complex boolean rule sets).
  - Quote workflow uses basic fields/statuses; no assignment/SLA/notifications yet.
- Pending:
  - Full drag-and-drop tree reorder UX for menu nodes.
  - Advanced conditional rule builder (AND/OR groups).
  - Quote notification hooks (email/WhatsApp) and ownership routing.

[2026-02-19 09:26 IST] Advanced Menu Rules + Quote Assignment/SLA Automation
- Developed:
  - Menu drag-drop tree operations added (drag handle + drop before/after/as-child targets) in Store Builder.
  - Advanced boolean visibility evaluator added to storefront menu rendering via `visibility.ruleJson` with `mode=all|any` and condition list (`field/op/value`).
  - Quote workflow expanded with assignment + SLA + priority metadata.
  - Quote automation endpoint added to process SLA-breached inquiries and send notification emails.
  - Assignment/status updates trigger assignee notification emails when SMTP configured.
  - Public quote submit can trigger alert email to `QUOTE_ALERT_EMAIL`.
- Partial:
  - Menu DnD UX is functional but still lightweight (no visual tree ghost previews).
  - Advanced boolean rule builder currently JSON-input driven per menu item (not a full visual expression designer).
  - SLA automation is manual trigger endpoint (button-driven), not scheduled worker/cron yet.
- Pending:
  - Fully visual AND/OR rule composer UI.
  - Background scheduler for periodic SLA checks.
  - Notification templates/escalation policies and assignment queues.

[2026-02-19 09:34 IST] Storefront Enhancements Wave (Items 1-7 progression)
- Developed:
  - Visual branding presets + typography pack application in Store Builder (one-click token apply).
  - Campaign templates and premium marketing block presets expanded (apply-ready bundles).
  - Rich product browse UX improved: category filter, grid/list layout switch, sticky cart/checkout bar.
  - Wholesale messaging upgraded with MOQ + pack-size hints from storefront config.
  - Public checkout flow wired end-to-end (`/api/public/storefront/{subdomain}/checkout`) creating customer + order + order items.
  - Theme runtime package scaffolding added on theme catalog (`TypographyPack`, `LayoutVariant`, `RuntimePackageJson`).
  - Full preview mode before apply enabled for store owner + platform owner via `previewThemeId` query flow.
- Partial:
  - Product listing UX is improved but still not a full dedicated PDP/PLP template engine.
  - Checkout is functional baseline; payment gateway handoff/3DS and advanced shipping/tax are pending.
  - Runtime package system is schema-enabled and preview-aware, but not yet a full compiled theme runtime pipeline.
- Pending:
  - Deep per-theme page layout variants with fully separate component packs.
  - Full checkout orchestration (coupons, shipping rules, tax engine, payment callback states).
  - Advanced sticky ATC behavior on dedicated PDP screens.

[2026-02-19 09:38 IST] CI Fix: StorefrontController compile error
- Developed:
  - Fixed C# compile error in premium section validator by removing invalid `out` capture inside local function.
  - `ContainsBlockedPremiumSection` now uses internal local variable and assigns `blockedKey` only after traversal success.
- Impact:
  - Resolves backend build failure seen in commits `68bfb62`, `e52bf32`, `032bf12`, `75afd72`, `b1f9fb7`, `6b10637`.

[2026-02-19 09:43 IST] Render crash hotfix (FormatException line 296)
- Fixed startup SQL format parsing failure in `Program.cs` by escaping JSON default braces for `ExecuteSqlRawAsync`.
- Changed SQL defaults from `'{}'` to `'{{}}'` in raw SQL strings so EF raw-sql formatter does not treat braces as format tokens.

[2026-02-19 10:01 IST] Env/Role dependency reduction + UX maturity pass
- Developed:
  - Added `QuoteAlertEmail` at store storefront settings level (reduces env-only dependency for quote alerts).
  - Public quote notifications now fallback to store-configured quote alert email if global env is missing.
  - Added public checkout payment callback endpoint to progress payment/order status beyond baseline checkout.
  - Added `PLATFORM_OWNER_BOOTSTRAP_PASSWORD` support for bootstrapping owner login access with role + unlocked account.
  - Upgraded menu rule UX from raw JSON-only to visual condition rows (AND/OR mode + field/op/value), while still storing JSON rule format.
  - Added menu drag-drop drop zones (before/after/child) for better tree reorder UX.
  - Expanded theme runtime scaffolding usage in public renderer (`TypographyPack`, `LayoutVariant`, `RuntimePackageJson`) and style adaptation.
- Partial:
  - Payment callback remains simulated/manual endpoint, not gateway webhook verified.
  - Runtime package still metadata-driven, not fully isolated runtime sandbox.
- Pending:
  - Fully visual boolean rule graph editor.
  - Production payment webhook verification/signature checks.
  - Hardened signed preview token system for theme preview sessions.

[2026-02-19 10:18 IST] Role/Permission model alignment + test-user permission binding
- Developed:
  - Expanded permission catalog to align with requested platform/store/customer atomic permission model (merchant governance, finance, plugins, API keys, security, store ops, customer perms).
  - Added platform staff default permission bundle in tenancy resolver (scoped read/masked-style capabilities).
  - Updated store role bundles to permission-first templates (Store Admin and Store Staff bundles).
  - Bound seeded test users to permissions by role on startup (`SEED_TEST_USERS=true`) by syncing `store_user_permissions` for owner/admin/staff users.
  - Kept role as bundle source but no feature exposure hardcoded by role names in frontend access checks.
- Notes:
  - Platform owner/platform staff permission exposure is resolved from platform role bundle templates at runtime.
  - Customer test user remains storefront-only by design (no admin/store permissions seeded).

[2026-02-19 10:27 IST] Auth permissions debug endpoint
- Developed:
  - Added `GET /api/auth/permissions` for production/debug verification of logged-in user's effective permissions.
  - Response includes: platform roles, store role, platform permissions, store permissions, and merged effective permissions.

[2026-02-19 10:43 IST] Strict permission-by-permission menu gating
- Developed:
  - Frontend dashboard menu rendering now enforces strict permission checks using `/api/auth/permissions` effective permission list.
  - Each sidebar item now maps to required permission set (`requiredAny`) and is shown only when user has matching permission(s) + valid scope.
  - Replaced scope-only visibility behavior with permission-aware + scope-aware combined gate.
- Impact:
  - Users now see menu/modules aligned to granted permissions, not just broad role type.

[2026-02-20] Storefront Theme Runtime Upgrade (Professional Ecommerce Layout)
- Module: Storefront System / Theme Runtime
- Status: Developed (major upgrade, further Shopify-grade depth pending)
- Frontend wired in: /Volumes/Rakesh/RBproject/sitesellr/frontend/src/pages/storefront/StorefrontPublic.js
- Implemented:
  - Professional storefront shell with top promo bar, sticky header, live menu, search, login/cart actions.
  - Home runtime sections upgraded: hero, product highlight cards, featured product grid/list switch.
  - Product detail route runtime: /s/:subdomain/products/:id with add-to-cart + quote CTA for wholesale mode.
  - Cart page runtime: quantity increment/decrement, remove, total + checkout handoff.
  - Checkout page runtime: structured form (name/email/phone/payment method) wired to public checkout API.
  - Customer login page layout route: /s/:subdomain/login (UI runtime page integrated in theme flow).
  - Footer runtime: commerce links, policy links, newsletter block.
  - Theme design token usage: primary/accent color wiring, typography pack preserved.
- Pending for full Shopify-grade target:
  - Full multi-theme PLP/PDP runtime variant matrix with dedicated template packs per category.
  - Advanced visual drag-drop canvas polish (deep nested drag, history timeline, collaboration).
  - Enterprise campaign/template marketplace billing orchestration.
  - Real customer auth/session workflow behind storefront login form.
- Verification:
  - Frontend build check blocked in local env because frontend deps are not installed (craco missing).

[2026-02-20] Phase Update - Theme Variant Engine + Campaign Billing + Customer Storefront Auth
- Module: Deep per-theme PLP/PDP variant engine (category-grade)
- Status: Developed (runtime-driven variant resolution implemented)
- Done:
  - Added theme metadata support for PLP/PDP variant maps (`PlpVariantsJson`, `PdpVariantsJson`).
  - Exposed variant maps via public storefront API response for runtime rendering.
  - Storefront runtime now resolves category-based PLP/PDP variants and applies variant-aware layouts.

- Module: Visual drag-drop/runtime editor polish
- Status: Partial (existing polished editor retained; enterprise freeform canvas still pending)
- Done:
  - Kept and integrated current advanced editor features (history, publish versions, diff, collaboration session hooks).
  - Strengthened campaign/template apply flow from backend catalog into editor.
- Pending:
  - Full freeform WYSIWYG canvas with deep nested drag targets + advanced inspector/collaboration timeline UX.

- Module: Campaign/template marketplace billing orchestration
- Status: Developed (v1 orchestration)
- Done:
  - Added campaign template catalog + store subscription/purchase models.
  - Added store APIs: list campaign templates and purchase/activate template with plan eligibility checks.
  - Added platform owner APIs: campaign template lifecycle create/update/list.
  - Wired Store Builder UI to load campaign templates from API and execute Purchase + Apply flow.

- Module: Real customer auth/session behind storefront login
- Status: Developed (v1 session auth)
- Done:
  - Added customer credential and session models (opaque hashed session token).
  - Added public APIs: customer register/login/me/logout scoped by storefront subdomain.
  - Added secure session cookie (`sf_customer_session`) flow with server-side session storage.
  - Wired storefront `/login` page to real auth APIs and live auth state.

- Verification:
  - `dotnet build` could not run in this local environment (`dotnet: command not found`).

[2026-02-20] Completion Pass - Pending Items Closure (Target Set)
- Full enterprise freeform visual editor
  - Status: Partial Completed
  - Done now:
    - Timeline replay controls improved (reset/play/pause/scrub range) for collaboration playback.
    - Advanced inspector + absolute/grid hybrid controls retained and integrated in existing builder.
  - Still pending for true enterprise parity:
    - Deep freeform nested drag target matrix + multi-user CRDT conflict resolution at canvas object granularity.

- Shopify-grade theme runtime depth
  - Status: Developed (major)
  - Done now:
    - Added per-theme category-grade PLP/PDP runtime variant metadata in theme model + APIs.
    - Storefront runtime now resolves PLP/PDP variants by category.
    - Runtime package handling moved to allowlisted/sanitized key model for safer runtime isolation.

- Campaign billing production hardening
  - Status: Developed (v2)
  - Done now:
    - Added campaign payment events table/model.
    - Added payment callback endpoint for campaign subscriptions.
    - Added refund + chargeback endpoints and event logging.

- Customer auth production hardening
  - Status: Developed (v2)
  - Done now:
    - Added email verification requirement + verify-email endpoint.
    - Added forgot password + reset password flow endpoints.
    - Added customer session list/revoke endpoints.
    - Added MFA challenge start/verify endpoints (OTP placeholder flow).
    - Storefront login page wired with security tools for verify/reset/session management.

- Ops/deploy completion
  - Status: Documented + ready
  - Done now:
    - Added concrete smoke-test checklist entries for campaign purchase/apply, customer auth flows, variant switching, and billing callback/refund/chargeback.
  - Action required in deployed environment:
    - Set `APPLY_MIGRATIONS_ON_STARTUP=true` for one deploy cycle to create/alter new tables/columns.
    - Execute smoke tests on deployed environment.

- Verification note:
  - Local compile command unavailable in this shell (`dotnet: command not found`).

[2026-02-20] Hotfix - Docker publish compile error CS0833
- Cause: duplicate anonymous property names in campaign payment callback response (`sub.Id` and `evt.Id`).
- Fix: renamed response fields to explicit names: `subscriptionId`, `billingStatus`, `eventId`.
- File: /Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Controllers/StorefrontController.cs

[2026-02-20] Theme Contract Enforcement (Multi-tenant Ecommerce-safe)
- Implemented strict platform theme contract validation service.
- Enforced mandatory templates at theme create/update:
  - homepage, product_listing, product_detail, cart, static_page, checkout
- Enforced mandatory plugin hooks:
  - BeforePrice, AfterPrice, BeforeAddToCart, AfterDescription
- Enforced schema-driven sections and blocked raw HTML-style fields.
- Added versioned contract metadata on themes:
  - TemplatesJson, SectionSchemasJson, HookPointsJson, ThemeVersion
- Wired platform theme UI fields for contract metadata input/edit.
- Exposed theme contract metadata via storefront/public APIs for runtime compliance checks.

[2026-02-20] Hotfix - Program.cs SQL string compile failure
- Issue: CS1056/CS1003 in Program.cs due to invalid backslash escaping inside verbatim SQL strings.
- Fix: corrected JSON default strings for `TemplatesJson` and `HookPointsJson` to proper verbatim-string quoting.
- File: /Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Program.cs

[2026-02-20] Platform Owner Theme ZIP Auto-Import
- Added platform-owner endpoint to upload/import theme zip: `POST /api/platform/themes/import-zip`.
- Import workflow:
  - Reads `theme.manifest.json` from zip root.
  - Validates theme contract (mandatory templates/hooks/schema) before saving.
  - Extracts only `assets/*` into `/wwwroot/theme-packages/{slug}/{version}/assets`.
  - Creates/updates theme catalog record automatically.
- Added Platform UI panel for ZIP upload/import in Platform Themes page.
- Added packaging guide: `/Volumes/Rakesh/RBproject/sitesellr/THEME_ZIP_SPEC.md`.

[2026-02-20] Subscription Capability Engine (Phase-1 Implemented)
- Added capability-centric billing plan model (limits + feature flags + capabilities JSON envelope).
- Added usage counters table/model (`store_usage_counters`) for monthly metering.
- Added backend service: `ISubscriptionCapabilityService` with:
  - effective capability resolution
  - server-side check for product creation limits
  - server-side check for theme apply limits/tier/premium access
  - usage counter retrieval/update
- Enforced limits at API layer:
  - Product create/update variant checks
  - Theme apply checks (tier/premium/install limit)
- Added subscription APIs:
  - `GET /api/stores/{storeId}/subscription/capabilities`
  - `GET /api/stores/{storeId}/subscription/usage`
  - `POST /api/stores/{storeId}/subscription/preview-check`
  - Platform owner billing plan management:
    - `GET /api/platform/billing-plans`
    - `POST /api/platform/billing-plans`
    - `PUT /api/platform/billing-plans/{id}`
- Onboarding plan endpoint now returns capability summary per plan.
- Seeded/upserted default plans with capability profiles: free, growth, pro, enterprise.
- Startup SQL migration-on-startup now includes new billing columns and usage table.

[2026-02-20] Deploy Hotfix - inotify/file watcher crash on Render
- Issue: `System.IO.IOException` due to inotify/file watcher limit during host startup.
- Fix: disabled host config reload-on-change watcher at process start using:
  - `DOTNET_HOSTBUILDER__RELOADCONFIGONCHANGE=false`
- File: /Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Program.cs

[2026-02-20] Platform Global Branding - Admin + Landing Effect
- Added backend platform branding settings API:
  - `GET /api/platform/branding` (public read)
  - `PUT /api/platform/branding` (platform owner)
- Added persistence model/table: `platform_branding_settings`.
- Added Platform Themes UI section to manage global branding values.
- Applied global branding effects to:
  - Admin shell (`DashboardLayout`) brand name/logo/color/font tokens
  - Landing page (`Landing.js`) brand name/logo/primary color/font + hero text overrides

[2026-02-20] Product/Order Hardening Pass
- Inventory reservation + concurrency-safe deduction:
  - Added `ReservedQuantity` on variants.
  - Added reservation APIs:
    - `POST /api/public/storefront/{subdomain}/cart/reserve`
    - `POST /api/public/storefront/{subdomain}/cart/release`
  - Checkout now deducts variant stock with atomic SQL condition check to prevent underflow.

- Category/product/variant limit enforcement:
  - Added categories API with subscription max category enforcement.
  - Product create and variant update limits already enforced via capability service.

- Bulk CSV import with validation report:
  - Added async import job endpoints:
    - `POST /api/products/import/csv?storeId=...`
    - `GET /api/products/import/jobs/{jobId}`
  - Includes partial success + row-level error reporting.

- Storefront product/page caching:
  - Added memory caching for public storefront listing and static pages.

- Test artifacts added:
  - `LOAD_TEST_PRODUCTS_ORDERS.md`
  - `tests/k6_products_orders.js`
  - `BACKEND_UI_WIRING_STATUS.md` (backendâ†”UI wiring coverage)

- Note:
  - Product import + reserve/release backend APIs are complete; frontend dedicated controls can be expanded next.

[2026-02-20] Frontend UI Wiring Pass - Products Import + Storefront Reservation
- Admin Products UI:
  - Wired CSV import button to backend async import API (`POST /api/products/import/csv?storeId=...`).
  - Added import job polling (`GET /api/products/import/jobs/{jobId}`) and status messaging.
  - Added inline top-10 row error preview for partial/failed imports.
- Public Storefront UI:
  - Wired explicit stock reservation button in cart.
  - Auto-reserves stock when entering checkout.
  - Checkout now enforces reservation before order submit and releases reservation after successful checkout.
  - Reservation status shown in cart/checkout panels.
- Frontend files:
  - `/Volumes/Rakesh/RBproject/sitesellr/frontend/src/pages/admin/Products.js`
  - `/Volumes/Rakesh/RBproject/sitesellr/frontend/src/pages/storefront/StorefrontPublic.js`

[2026-02-20] Platform RBAC UI Wiring - User Categories + Side Menu
- Added backend list APIs for RBAC assignment screen:
  - `GET /api/platform/rbac/users` (email/id/platform roles/store membership count)
  - `GET /api/platform/rbac/stores` (store id/name/subdomain/status)
- Updated Platform RBAC frontend to include side menu style user picker with two categories:
  - `Platform Users`
  - `Store Users`
- Selection now pre-fills assignment forms:
  - Platform user -> platform role assignment
  - Store user -> store permission assignment
- Files:
  - `/Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Controllers/PlatformRbacController.cs`
  - `/Volumes/Rakesh/RBproject/sitesellr/frontend/src/pages/admin/PlatformRbac.js`

[2026-02-20] Render/CI Fix - React Hooks Rule Compliance
- Fixed `StorefrontPublic` hook-order lint failures that broke frontend CI.
- Moved loading/error early returns below all hooks and hardened data access with optional chaining so hooks execute in stable order for every render.
- File:
  - `/Volumes/Rakesh/RBproject/sitesellr/frontend/src/pages/storefront/StorefrontPublic.js`

[2026-02-20] Platform Owner Menu Restructure
- Updated platform owner sidebar menu to align with super-admin governance model.
- Added platform-owner menu entries:
  - Dashboard
  - Merchant / Store Management
  - Payments & Transactions
  - Billing & Subscriptions
  - Plugin / App Marketplace
  - API & Integrations
  - Security & Audit
  - Risk / Fraud Monitoring
  - Platform Configuration
  - Reporting & Intelligence
  - Role / Permission Governance
  - Platform Themes
- Added new platform module routes/pages for missing sections:
  - `/admin/platform-payments`
  - `/admin/platform-billing`
  - `/admin/platform-plugins`
  - `/admin/platform-api`
  - `/admin/platform-risk`
  - `/admin/platform-config`
  - `/admin/platform-reports`
- Enforced separation rule: when user is platform owner, store-only menus are hidden from sidebar.
- Files:
  - `/Volumes/Rakesh/RBproject/sitesellr/frontend/src/components/layouts/DashboardLayout.js`
  - `/Volumes/Rakesh/RBproject/sitesellr/frontend/src/App.js`
  - `/Volumes/Rakesh/RBproject/sitesellr/frontend/src/pages/admin/PlatformModule.js`

[2026-02-20] Merchant/Store Management Visibility Fix
- Fixed platform merchant list API to include mapped stores per merchant.
- Updated merchant management UI to show store count and store rows (name, subdomain, status).
- This resolves issue where demo merchant appeared but store details were not visible in platform owner screen.
- Files:
  - `/Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Controllers/MerchantsController.cs`
  - `/Volumes/Rakesh/RBproject/sitesellr/frontend/src/pages/admin/Merchants.js`

[2026-02-20] Platform Owner Modules - Full Backend Wiring Pass
- Added platform-owner backend module APIs:
  - `GET /api/platform/owner/payments`
  - `GET /api/platform/owner/billing`
  - `GET /api/platform/owner/plugins`
  - `PUT /api/platform/owner/plugins/kill-switch`
  - `GET /api/platform/owner/api-integrations`
  - `PUT /api/platform/owner/api-integrations/config`
  - `GET /api/platform/owner/risk`
  - `GET /api/platform/owner/reports`
  - `GET /api/platform/owner/config`
  - `PUT /api/platform/owner/config`
- Wired all new Platform Owner menu pages to real backend data and actions:
  - Payments & Transactions: live counts + recent transaction feed
  - Billing & Subscriptions: plan/subscription metrics + create-plan action
  - Plugin / App Marketplace: ecosystem metrics + kill-switch control
  - API & Integrations: token/login metrics + API governance config save
  - Risk / Fraud Monitoring: risk counters + alert list
  - Platform Configuration: global config read/write
  - Reporting & Intelligence: monthly revenue, merchant growth, security events
- Files:
  - `/Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Controllers/PlatformOwnerModulesController.cs`
  - `/Volumes/Rakesh/RBproject/sitesellr/frontend/src/pages/admin/PlatformModule.js`

[2026-02-20] RBAC Simplification - Default User-Type Assignment
- Simplified role/permission management flow for platform owner:
  - Removed manual CSV-based role/permission editing UI.
  - Added two default assignment actions:
    - Assign `Platform Staff` default permissions
    - Assign `Store Owner` default permissions (store-specific)
- Backend added endpoint:
  - `POST /api/platform/rbac/users/{userId}/assign-default`
  - Supported types: `platform_staff`, `store_owner`
- Behavior:
  - `platform_staff`: sets platform role to Staff.
  - `store_owner`: sets store role to Owner and applies owner default permission template.
- Files:
  - `/Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Controllers/PlatformRbacController.cs`
  - `/Volumes/Rakesh/RBproject/sitesellr/frontend/src/pages/admin/PlatformRbac.js`

[2026-02-20] RBAC UI Modernization + Role-Aware Selection
- Redesigned Platform RBAC page to a modern role-management workflow.
- Behavior updates:
  - Select user type -> shows related users list with role badges.
  - Click user -> fetch and display current role.
  - Update role directly from role selector.
- Added backend role APIs for store-user role management:
  - `GET /api/platform/rbac/stores/{storeId}/users/{userId}/role`
  - `PUT /api/platform/rbac/stores/{storeId}/users/{userId}/role`
- Platform role update now uses simple role selector (Owner/Staff) with current role preloaded.
- Store role update now uses simple role selector (Owner/Admin/Staff) scoped by selected store.
- Files:
  - `/Volumes/Rakesh/RBproject/sitesellr/frontend/src/pages/admin/PlatformRbac.js`
  - `/Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Controllers/PlatformRbacController.cs`

[2026-02-20] CSRF Invalid Fix for Admin API Calls
- Fixed `csrf_invalid` on authenticated admin requests.
- Change: CSRF middleware now skips CSRF token validation for requests using `Authorization: Bearer ...`.
- Rationale: these are token-authenticated API calls (not cookie-identity session actions), so CSRF double-submit check is not required.
- File:
  - `/Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Security/CsrfMiddleware.cs`

[2026-02-20] RBAC Role Display Clarity Fix
- Fixed user list confusion in RBAC UI:
  - Store-user view now displays `Store Role` badges instead of `No Platform Role`.
- Backend user list now returns `storeRoles` summary per user.
- Frontend selected-user panel now shows both platform roles and store roles.
- Files:
  - `/Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Controllers/PlatformRbacController.cs`
  - `/Volumes/Rakesh/RBproject/sitesellr/frontend/src/pages/admin/PlatformRbac.js`

[2026-02-20] Auto Menu by Role on Login (No Manual Store Selection Needed)
- Fixed role/menu auto-loading issue after login for store-role users.
- Backend tenancy resolver now auto-binds first store membership when request has no store context header.
- Result:
  - Store role + permissions are resolved immediately at login.
  - Dashboard sidebar/menu now appears automatically as per assigned role.
- File:
  - `/Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Services/TenancyContext.cs`

[2026-02-20] Store Owner Login - Store Auto-Selection Fix
- Fixed store-owner product/settings pages showing `Store is not selected` after login.
- Backend tenancy fallback improved:
  - If `X-Store-Id` points to a store where user has no membership, resolver now falls back to user's first valid store membership.
- Frontend active-store hook improved:
  - If current stored storeId is missing/invalid against fetched stores, it auto-selects first available store.
- Files:
  - `/Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Services/TenancyContext.cs`
  - `/Volumes/Rakesh/RBproject/sitesellr/frontend/src/hooks/useActiveStore.js`

[2026-02-20] Store Owner Live Data Pass - Dashboard, Marketing, Analytics
- Replaced demo/mock behavior with backend-wired store insights modules.
- Backend added store insights controller with live APIs:
  - `GET /api/stores/{storeId}/insights/dashboard?range=...`
  - `GET /api/stores/{storeId}/insights/analytics?range=...`
  - `GET /api/stores/{storeId}/insights/marketing?range=...`
- Dashboard page now loads:
  - live revenue/orders/customers/conversion metrics
  - live trend series and category split
  - recent orders and recent activity logs
- Analytics page now loads:
  - live metrics (revenue/orders/AOV/customers/conversion)
  - live revenue trend, order status split, top products by revenue
- Marketing page now loads:
  - live campaign subscription metrics/spend/template counts/inquiries
  - live campaign subscriptions and payment event feed
  - live template list with activate action (`purchase` API)
- Files:
  - `/Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Controllers/StoreInsightsController.cs`
  - `/Volumes/Rakesh/RBproject/sitesellr/frontend/src/pages/admin/Dashboard.js`
  - `/Volumes/Rakesh/RBproject/sitesellr/frontend/src/pages/admin/Marketing.js`
  - `/Volumes/Rakesh/RBproject/sitesellr/frontend/src/pages/admin/Analytics.js`

[2026-02-20] Store Owner Login Fix - Missing Store Settings Read Permission
- Root cause found: store role templates did not include `store.settings.read`, so `/api/stores` returned forbidden for store users.
- Fix applied in permission catalog templates:
  - Owner/Admin template now includes `store.settings.read` and `store.settings.write`.
  - Staff template now includes `store.settings.read`.
- Result:
  - Store users (including `store.owner@sitesellr.local`) can load own store context and dashboard/pages no longer show "Store is not selected".
- File:
  - `/Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Security/PermissionCatalog.cs`

[2026-02-20] Store Context Hardening - /api/stores Membership List
- Fixed store-owner/store-staff login edge case where UI showed `Store is not selected` despite valid membership.
- Backend `/api/stores` list endpoint now uses authenticated membership scope:
  - Platform users: can list platform stores.
  - Store users: can list only stores where they are members.
- Endpoint no longer depends on `StoreSettingsRead` policy for basic store-context discovery.
- Result:
  - Active store selection works reliably after login for `store.owner@sitesellr.local` and other store users.
- File:
  - `/Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Controllers/StoresController.cs`

[2026-02-20] Login Store Binding - Default Store ID from Auth
- Implemented store binding in auth flow so store users get store context directly at login.
- Backend token response now includes `default_store_id` (first mapped store by role priority).
- Applied to:
  - `/api/auth/login`
  - `/api/auth/refresh`
  - `/api/auth/webauthn/login/verify`
- Frontend now persists and applies `default_store_id` immediately after login.
- Logout now clears stored store context to prevent stale-store leakage between users.
- Also aligned onboarding/invite flows to set `X-Store-Id` immediately after store assignment.
- Files:
  - `/Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Models/User.cs`
  - `/Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Program.cs`
  - `/Volumes/Rakesh/RBproject/sitesellr/frontend/src/pages/auth/Login.js`
  - `/Volumes/Rakesh/RBproject/sitesellr/frontend/src/lib/session.js`
  - `/Volumes/Rakesh/RBproject/sitesellr/frontend/src/components/layouts/DashboardLayout.js`
  - `/Volumes/Rakesh/RBproject/sitesellr/frontend/src/pages/auth/Onboarding.js`
  - `/Volumes/Rakesh/RBproject/sitesellr/frontend/src/pages/auth/AcceptInvite.js`

[2026-02-20] Theme Activate/Preview Reliability Fix
- Fixed storefront theme activation and preview usability issues.
- Store builder updates:
  - Added explicit `Activate` button on each theme card (instead of card-click only behavior).
  - Added user-friendly plan/feature error messages when activation is blocked by subscription rules.
  - Wired top-right `Preview` button to open preview for currently active theme.
  - Preview now always passes `storeId` and `previewThemeId` query params.
- Public storefront preview updates:
  - Public storefront API now supports fallback `storeId` query if subdomain is missing/unset (preview-safe).
  - Static page API now also supports the same `storeId` fallback.
- Subscription gating correction:
  - Theme apply no longer consumes install quota counter on every activation click.
  - Activation is treated as theme switch; install quota remains for marketplace install flow.
- Files:
  - `/Volumes/Rakesh/RBproject/sitesellr/frontend/src/pages/admin/StoreBuilder.js`
  - `/Volumes/Rakesh/RBproject/sitesellr/frontend/src/pages/storefront/StorefrontPublic.js`
  - `/Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Controllers/PublicStorefrontController.cs`
  - `/Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Services/SubscriptionCapabilityService.cs`

[2026-02-20] Domains, Cloudflare Mapping, SSL Purchase + Issue Flow
- Implemented automatic DNS provisioning for custom domains via Cloudflare API:
  - Auto CNAME mapping for custom hostname -> platform ingress.
  - Auto TXT verification record `_sitesellr-verify.<hostname>`.
  - Added Cloudflare DNS check API path for verify/retry status.
- Implemented marketplace-style SSL purchase gate for custom domains:
  - New domain fields: DNS management status, SSL purchased flag, purchase reference/time.
  - Custom domain SSL issuance now requires purchase first (`ssl_purchase_required`) when enabled.
  - Added endpoint: `POST /api/stores/{storeId}/domains/{domainId}/purchase-ssl`.
- Enhanced domain verification flow:
  - Verify now checks Cloudflare DNS record state (CNAME + TXT) and updates domain status.
  - If verified and SSL is purchased, cert issuance is auto-triggered.
- Subdomain automation updates:
  - Store creation now auto-generates unique subdomain from store name when blank.
  - Onboarding store setup now auto-generates unique subdomain if user does not enter one.
  - On onboarding complete, tenant subdomain DNS provisioning is triggered automatically.
- Tenancy host resolution update:
  - Added verified custom-domain lookup in tenancy resolver (store domain -> store context).
- Frontend Domains & SSL page wiring updates:
  - Added DNS record hint card (CNAME + TXT fallback values).
  - Added `Buy SSL` action for custom domain.
  - Added better status display (`dnsStatus`, `sslPurchased`, `sslStatus`) and guarded `Issue SSL` button.
- Files:
  - `/Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Services/CloudflareDnsService.cs`
  - `/Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Controllers/DomainSslController.cs`
  - `/Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Models/Storefront.cs`
  - `/Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Data/AppDbContext.cs`
  - `/Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Program.cs`
  - `/Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Controllers/StoresController.cs`
  - `/Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Services/TenancyContext.cs`
  - `/Volumes/Rakesh/RBproject/sitesellr/frontend/src/pages/admin/DomainsSsl.js`

[2026-02-20] Platform Owner Domain Control Center + Configurable Cloudflare/SSL Runtime
- Added platform-owner domain center (new menu/module):
  - View all tenant subdomains across stores.
  - View all custom domains with DNS/verification/SSL purchase/SSL status per domain.
  - Platform summary metrics: total domains, verified, active SSL, pending, payment-required.
- Added platform-owner domains config API + UI:
  - Cloudflare API token, zone id, base domain, ingress host.
  - Let's Encrypt issuer command and contact email.
  - SSL marketplace purchase toggle (`require_marketplace_purchase`).
- Runtime integration:
  - Cloudflare DNS service now reads platform-owner saved config from DB (fallback to env vars).
  - Let's Encrypt issuer now reads platform-owner saved config from DB (fallback to env vars).
- Subdomain uniqueness logic clarified and exposed:
  - Requested subdomain is normalized.
  - If taken, system appends numeric suffix (`demo`, `demo1`, `demo2`, ...).
- Added platform menu route:
  - `/admin/platform-domains`
- Files:
  - `/Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Controllers/PlatformOwnerModulesController.cs`
  - `/Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Services/CloudflareDnsService.cs`
  - `/Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Services/SslService.cs`
  - `/Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Controllers/DomainSslController.cs`
  - `/Volumes/Rakesh/RBproject/sitesellr/backend-dotnet/Program.cs`
  - `/Volumes/Rakesh/RBproject/sitesellr/frontend/src/pages/admin/PlatformModule.js`
  - `/Volumes/Rakesh/RBproject/sitesellr/frontend/src/components/layouts/DashboardLayout.js`
  - `/Volumes/Rakesh/RBproject/sitesellr/frontend/src/App.js`

---
Update 2026-02-21 (Advanced Domain/SSL automation hardening)
- Developed: Platform-owner Domains & SSL module now supports ACME runtime config fields (`acmeClient`, `acmeChallengeMethod`, `acmeDirectoryUrl`) end-to-end (API + UI).
- Developed: Cloudflare connectivity test endpoint + zones listing endpoint added for direct token validation and zone discovery.
- Developed: SSL provider runtime health check endpoint added to validate configured issuer command binary in runtime container.
- Developed: Domain config save now persists ACME settings in platform settings store.
- Partial: Cloudflare direct OAuth-style auth flow is not implemented; token-based secure API integration is implemented.
- Partial: ACME issuance depends on runtime tool installation (`certbot`/`acme.sh`/`lego`) and valid command template in config.

Update 2026-02-21 (Module load fix + Cloudflare OAuth-style connect)
- Developed: Fixed EF query translation issue in platform-owner modules by replacing `StartsWith(..., StringComparison...)` database filters with PostgreSQL-safe `EF.Functions.ILike(...)` filters.
- Impact: Resolved "Could not load module data" for API & Integrations, Platform Configuration, Domains & SSL (Platform), Reporting & Intelligence modules.
- Developed: Added Cloudflare OAuth-style connect flow endpoints (`start` + `callback`) with state handling, token exchange, and platform token persistence.
- Developed: Added OAuth config fields in Domains & SSL platform UI and backend config persistence for authorize/token URLs, client id/secret, redirect URI, scope, post-connect redirect.
- Partial: OAuth flow requires correct Cloudflare OAuth app credentials/endpoints configured in platform domain settings.

Update 2026-02-21 (OAuth defaults + SSL pricing workflow)
- Developed: Cloudflare OAuth defaults now auto-filled (`authorize`/`token` URLs) and redirect URI auto-generates from current host when empty.
- Developed: Platform Domains config now supports SSL marketplace price (`platform.domains.ssl.price_inr`).
- Developed: Store Domains UI now shows SSL price and uses it in Buy SSL call-to-action.
- Developed: Store domain list/add/purchase APIs now return `sslPriceInr` so frontend shows consistent pricing from backend config.
- Partial: Payment gateway charge capture for SSL purchase is still simulated via payment reference; full gateway callback reconciliation remains pending.

Update 2026-02-21 (Subdomain hardening + wildcard CORS support)
- Developed: Added strict subdomain policy service with DNS-safe pattern checks + reserved name blocking (`www`, `api`, `admin`, etc.).
- Developed: Onboarding store setup now rejects invalid/reserved subdomains with explicit error codes (`subdomain_invalid`, `subdomain_reserved`).
- Developed: Store create/update APIs now enforce strict subdomain validation before save.
- Developed: CORS policy now supports wildcard subdomain origins via `CORS_ORIGINS` patterns like `https://*.ourmaindomain.com`.
- Partial: Origin TLS (Cloudflare-to-origin certificate lifecycle) is still infrastructure-managed outside app runtime.

Update 2026-02-21 (Origin TLS lifecycle automation)
- Developed: Added Origin TLS lifecycle service with platform-config-driven settings (`mode`, `issuer_command`, `cert_path`, `key_path`).
- Developed: Added platform-owner endpoints:
  - `GET /api/platform/owner/domains/origin-tls/status`
  - `POST /api/platform/owner/domains/origin-tls/issue`
- Developed: Domains config now persists origin TLS settings and exposes them in Domains & SSL module.
- Developed: Platform Domains UI now includes origin TLS config form + issue/renew action + status refresh (expiry/days remaining visibility).
- Partial: Scheduler/cron-based automatic renew trigger is not yet added; current renew is owner-triggered API call.

Update 2026-02-21 (Product media management upgrade)
- Developed: Product Add/Edit now supports multiple image URLs in media section.
- Developed: Image ordering controls added (drag-and-drop + move up/down) and preserved via `sortOrder` in product payload.
- Developed: Optional product video URL support added in product editor and persisted in media list.
- Developed: Asset preview added in product editor for images and video/link preview.
- Partial: File upload storage pipeline (instead of URL-based media entry) is still pending.

Update 2026-02-21 (Product direct upload pipeline + image normalization + category list)
- Developed: Added backend media asset pipeline service used by product and storefront media uploads.
- Developed: Direct product media file upload endpoint added (`POST /api/products/media/upload?storeId=...`) with store tenancy checks.
- Developed: Image-from-URL ingestion endpoint added (`POST /api/products/media/fetch-url?storeId=...`) to fetch and optimize external image URLs.
- Developed: Automatic image optimization to a single normalized size (1200x1200, WebP output) on upload and URL-fetch ingestion.
- Developed: Product video file upload support (`mp4/webm/mov`) in product media flow.
- Developed: Product UI now supports direct image/video upload + fetch-and-optimize for URL entries.
- Developed: Category list wired into product page filter and add/edit product form category selector.
- Developed: Quick category creation added in product add/edit dialog.
- Partial: CDN object storage push (S3/R2 direct object write) still depends on ASSET_BASE_URL/object-store integration strategy; current pipeline stores in app uploads path and can be fronted by CDN.

Update 2026-02-21 (Automatic image normalization enforced)
- Developed: Product save flow now auto-normalizes all non-managed image URLs before save, ensuring uniform optimized image output.
- Developed: Backend Products create/update now also normalizes external image URLs server-side to enforce same-size optimized assets even if frontend is bypassed.
- Developed: Normalized image pipeline outputs consistent 1200x1200 WebP media for catalog usage.

Update 2026-02-21 (Dynamic CORS whitelist controls: platform + store owner)
- Developed: Added dynamic CORS origin registry service with 60-second refresh, merging env + platform + store-level origin lists.
- Developed: Platform-level CORS whitelist configuration added in Platform Configuration (`corsOriginsCsv`), persisted and applied at runtime.
- Developed: Store owner CORS whitelist APIs added:
  - `GET /api/stores/{id}/cors-origins`
  - `PUT /api/stores/{id}/cors-origins`
- Developed: Store owner Settings UI now includes `Store CORS Allowed Origins (CSV)` and saves with general settings.
- Developed: CORS middleware now uses runtime registry matcher (including wildcard hosts like `https://*.sitesellr.com`) instead of static startup-only list.
- Clarification: login may succeed while add-product fails when preflight/credentialed API requests use a different origin/header set; dynamic CORS allowlist now addresses this path.

Update 2026-02-21 (Build fix for product media normalization)
- Developed: Fixed compile error in product create flow by converting normalized media list to ICollection-compatible type.
- Developed: Upgraded ImageSharp package from 3.1.6 to 3.1.8 to reduce known vulnerability exposure from prior version.
- Note: CS8602 warning in CsrfMiddleware is non-blocking warning (publish does not fail on it).

Update 2026-02-21 (Permanent store selection + CORS save fix)
- Developed: Settings page now uses active store context directly (`useActiveStore`) instead of separate store list fetch source, removing mismatch causing "Select a store first".
- Developed: Store settings + store CORS save now use fallback `storeId` from active context even when `selectedStore` object is delayed.
- Developed: Auth access endpoint now returns `currentStoreId/currentStoreName` to support deterministic store binding after login.
- Developed: Active store hook now reads `/auth/access` and auto-selects current store from login tenancy when needed.
- Impact: Store owner can save `Store CORS Allowed Origins (CSV)` without manual re-select loops.
